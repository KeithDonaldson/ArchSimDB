<metal:macro use-macro="master">
    <metal:slot fill-slot="title">
        <title>Compare | ArchSim DB</title>
    </metal:slot>

    <metal:slot fill-slot="head">
        <!-- DataTables CSS -->
        <link href="${request.static_url('proj:static/vendor/datatables-plugins/dataTables.bootstrap.css')}" rel="stylesheet">
        <link href="${request.static_url('proj:static/vendor/datatables-responsive/dataTables.responsive.css')}" rel="stylesheet">
        <link href="${request.static_url('proj:static/vendor/jstree/dist/themes/default/style.min.css')}" rel="stylesheet"  />
    </metal:slot>

    <metal:slot fill-slot="scripts">
        <!-- DataTables JavaScript -->
        <script src="${request.static_url('proj:static/vendor/datatables/js/jquery.dataTables.min.js')}"></script>
        <script src="${request.static_url('proj:static/vendor/datatables-plugins/dataTables.bootstrap.min.js')}"></script>
        <script src="${request.static_url('proj:static/vendor/datatables-responsive/dataTables.responsive.js')}"></script>
        <script src="${request.static_url('proj:static/vendor/multiselect/multiselect.min.js')}"></script>
        <script src="${request.static_url('proj:static/vendor/jstree/dist/jstree.min.js')}"></script>

        <script type="text/javascript" id="data" data="${hierarchy}">
            jQuery(document).ready(function($) {
                var data = JSON.parse($("#data").attr("data").replace(/'/g, '"'));

                var $select = $('<select name="from" id="search" class="form-control" size="8" multiple="multiple">');
                $select.appendTo("#fromfield");

                for (var exp in data) {
                    for (var conf in data[exp]) {
                        var $optgroup = $("<optgroup>", {label: exp + ' -> ' + conf});
                        $optgroup.appendTo($select);
                        for (var app in data[exp][conf]) {
                            var $option = $("<option>", {text: app, value: exp + '/' + conf + '/' + app});
                            $option.appendTo($optgroup);
                        }
                    }
                }

                $('#search').multiselect({
                    search: {
                        left: '<input type="text" name="q" class="form-control" style="margin-bottom: 10px;" placeholder="Search..." />',
                        right: '<input type="text" name="q" class="form-control" style="margin-bottom: 10px;" placeholder="Search..." />',
                    },
                    keepRenderingSort: true
                });

                $('#fields').multiselect({
                    search: {
                        left: '<input type="text" name="q" class="form-control" style="margin-bottom: 10px;" placeholder="Search..." />',
                        right: '<input type="text" name="q" class="form-control" style="margin-bottom: 10px;" placeholder="Search..." />',
                    },
                    keepRenderingSort: true
                });

                $("#tree").jstree({
                    "types": {
                        "default": {
                            "icon": "fa fa-folder-open treeFolderIcon",
                        }
                    },
                    "plugins": ["json_data", "checkbox"],
                    "core": {
                        "multiple": false,
                        "data": {
                            "data" : function(node){
                                return {"id" : node.id};
                            },
                            "url" : function(node){
                                var url = "/get/hierarchy";
                                if(node.id === "child")
                                    url = "/get/hierarchy/" + node.id;
                                return url;
                            }
                        }
                    },
                });
            });

            var submitted_apps;

            function submit_apps() {
                var selectList = $("#fields");
                var selectList_to = $("#fields_to");
                var myApps = document.getElementById('search_to').options;
                var apps = []

                for (var i = 0; i < myApps.length; i++) {
                    apps.push(myApps[i].value);
                }
                submitted_apps = apps;

                selectList.empty();
                selectList_to.empty();

                $.post( "get/fields", { 'apps': apps }, function( data ) {
                    if (data != null) {
                        $("#select_rows").hide();
                        $("#loading_row").show();
                        var fields = data['fields'];
                        $.each(fields, function (index, item) {
                            selectList.append(new Option(item, item));
                        });
                        $("#loading_row").hide();
                        $("#select_rows").show();
                    }
                });
            };

            function submit_compare() {
                var apps = submitted_apps;
                var fields = document.getElementById('fields_to').options;
                var fieldsList = []
                var composite_used = false;

                for (var i = 0; i < fields.length; i++) {
                    fieldsList.push(fields[i].value);
                    if (fields[i].value[0] == '$') {
                        composite_used = true;
                    }
                }

                if (composite_used == true) {
                    if (confirm("This process uses Python's eval() method and trusts that your " +
                                    "composite stats are correct. Continue?") == true) {
                    } else {
                        return;
                    }
                }

                var parameters = {'apps': apps, 'fields': fieldsList};
                var form = $('<form></form>');

                form.attr("method", "post");
                form.attr("action", '/compare/results');

                $.each(parameters, function(key, value) {
                    if ( typeof value == 'object' || typeof value == 'array' ){
                        $.each(value, function(subkey, subvalue) {
                            var field = $('<input />');
                            field.attr("type", "hidden");
                            field.attr("name", key+'[]');
                            field.attr("value", subvalue);
                            form.append(field);
                        });
                    } else {
                        var field = $('<input />');
                        field.attr("type", "hidden");
                        field.attr("name", key);
                        field.attr("value", value);
                        form.append(field);
                    }
                });
                $(document.body).append(form);
                form.submit();
            };
        </script>
    </metal:slot>

    <metal:slot fill-slot="body">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Compare</h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <div class="row">
            <div class="col-lg-12">
                <p>This tool allows you to compare the data from multiple applications. There is no limit
                    on the number of applications that can be compared, but keep in mind that the more you add
                    the slower the results will arrive. A lot of data sifting is being done in this page, so please
                    bear in mind it may take a while.</p>
            </div>
        </div>

        <div class="row" id="select_apps">
            <!--?<div class="col-lg-12">-->
            <!--?<h2>Select Applications</h2>-->
            <!--?</div>-->

            <!--?<div class="col-xs-5" id="fromfield">-->
            <!--?</div>-->

            <!--?<div class="col-xs-2">-->
            <!--?<button type="button" id="search_undo" class="btn btn-primary btn-block">undo</button>-->
            <!--?<button type="button" id="search_rightAll" class="btn btn-block"><i class="glyphicon glyphicon-forward"></i></button>-->
            <!--?<button type="button" id="search_rightSelected" class="btn btn-block"><i class="glyphicon glyphicon-chevron-right"></i></button>-->
            <!--?<button type="button" id="search_leftSelected" class="btn btn-block"><i class="glyphicon glyphicon-chevron-left"></i></button>-->
            <!--?<button type="button" id="search_leftAll" class="btn btn-block"><i class="glyphicon glyphicon-backward"></i></button>-->
            <!--?<button type="button" id="search_redo" class="btn btn-warning btn-block">redo</button>-->
            <!--?</div>-->

            <!--?<div class="col-xs-5">-->
            <!--?<select name="to" id="search_to" class="form-control" size="8" multiple="multiple"></select>-->
            <!--?</div>-->

            <div id="tree"></div>

            <div class="col-lg-12">
                <button type="submit" onclick="submit_apps();" class="btn btn-primary btn-lg btn-block" style="margin-top: 20px;">Submit</button>
            </div>
        </div>

        <div id="loading_row" style="display: none; margin-top: 20px; text-align: center;" class="row">
            <img src="${request.static_url('proj:static/loader.gif')}" alt="loading..." width="60px" />
            <p>Loading...</p>
        </div>

        <div class="row" id="select_rows" style="display: none;">
            <div class="col-lg-12">
                <hr>
                <h2>Select Fields</h2>
            </div>

            <div class="col-xs-5">
                <select name="fields" id="fields" class="form-control" size="8" multiple="multiple">
                </select>
            </div>

            <div class="col-xs-2">
                <button type="button" id="fields_undo" class="btn btn-primary btn-block">undo</button>
                <button type="button" id="fields_rightAll" class="btn btn-block"><i class="glyphicon glyphicon-forward"></i></button>
                <button type="button" id="fields_rightSelected" class="btn btn-block"><i class="glyphicon glyphicon-chevron-right"></i></button>
                <button type="button" id="fields_leftSelected" class="btn btn-block"><i class="glyphicon glyphicon-chevron-left"></i></button>
                <button type="button" id="fields_leftAll" class="btn btn-block"><i class="glyphicon glyphicon-backward"></i></button>
                <button type="button" id="fields_redo" class="btn btn-warning btn-block">redo</button>
            </div>

            <div class="col-xs-5">
                <select name="fields_to" id="fields_to" class="form-control" size="8" multiple="multiple"></select>
            </div>

            <div class="col-lg-12">
                <button type="submit" onclick="submit_compare();" class="btn btn-primary btn-lg btn-block" style="margin-top: 20px;">Submit</button>
            </div>
        </div>
    </metal:slot>
</metal:macro>